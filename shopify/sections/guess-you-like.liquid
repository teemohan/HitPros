<style>
  .new-bg-over-2{
  background: #F9F9F9;
}
</style>

{%- assign gtm_type = 'homepage' -%}
{%- if template == 'cart' -%}
  {%- assign gtm_type = 'cart' -%}
{%- endif -%}
{% comment %} <form 
  method="post" 
  action="/cart/add"
  class="w-full"
  enctype="multipart/form-data"
  is="product-form"
  data-recommend-module="{{gtm_type}}/{{- section.settings.title -}}"
  >
  <input type="hidden" name="form_type" value="product">
  <input type="hidden" name="utf8" value="âœ“">
  <input type="hidden" name="quantity" value="${item.moq || 1}">
  <input type="hidden" name="id" value="${item.variantId || ''}">
  <input type="hidden" disabled name="sku" value="${item.skuCode || ''}">
  <button is="loader-button" type="submit" class="w-full h-10 fb-md:h-12 flex items-center justify-center rounded-sm bg-button text-main font-bold text-sm fb-md:text-base transition-all duration-200 hover:bg-opacity-90 relative">
    <span class="flex items-center gap-2">
      Add to Cart
    </span>
    <span class="hidden" hidden>
      <div class="inline-block">
        <svg focusable="false" width="24" height="24" class="animate-spin" viewBox="25 25 50 50">
          <circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="5"/>
        </svg>
      </div>
    </span>
  </button>
  <input type="hidden" name="product-id" value="${item.id || ''}">
  <input type="hidden" name="section-id" value="${item.sectionId || ''}">
</form> {% endcomment %}
        
<div class="js-guesslike-gtm w-full py-7.5 fb-md:py-10 js-guess-{{ section.id }} {% if gtm_type == 'cart' %} new-bg-over-2 {% else %} new-bg-over  {% endif %}   ">
  <div class="container w-full overflow-hidden">
    <div class="flex items-center justify-between mb-5 fb-md:mb-6">
      <h2 class="text-20 fb-md:text-30 font-semibold text-121212">{{ section.settings.title }}</h2>
    </div>
    <div class="relative w-full mx-auto fb-hover-list">
      <div class="swiper overflow-visible relative">
        <div class="js-guess-content swiper-wrapper"
          data-datalayer="true" 
          data-event-type="view_item_list" 
          data-list-name="recommended_product_exposure" 
          data-scope-id= "{{ section.id }}"
          data-recommend-module="{{- gtm_type -}}/{{- section.settings.title -}}"
        >
          <div class="transition duration-200 relative w-full rounded h-20r fb-md:h-27r">
            <div class=" w-full h-full bg-gray-200 pulse"></div>
          </div>
        </div>
      </div>
      <div class="mt-4 fb-sm:mt-6 flex items-center justify-between fb-md:space-x-10 relative z-1 ">
        <div class="swiper-scrollbar !static flex w-full fb-md:flex-1"></div>
        <div class="hidden js-swiper-btns items-center justify-end space-x-4 fb-md:w-20">
           {%- render 'northsky-prev-next', type: 'button' -%}
        </div>
      </div>
    </div>
  </div>
</div>
<style>
 @media screen and (min-width: 1200px) {
    .fb-hover-list:before,.fb-hover-list:after {
      content: "";
      position: absolute;
      top: 0;
      width: 150px;
      height: 100%;
      background: transparent;
      z-index: 2;
    }
    .fb-hover-list:before{
      left: -160px;
    }
    .fb-hover-list:after {
      right: -170px;
    }
  }
</style>
<script type="text/javascript">
  $(function() {
    class GuessYouLike {
      constructor(sectionId) {
        this.sectionId = sectionId;
        this.sectionElement = document.querySelector('.js-guess-' + sectionId);
      }
      createProductHtml(item) {
        const skyprice = skyFormatPriceDisplay(item.price || '0.00');
        const smallsku = item.skuCode.toLowerCase()
        return `
          <div class="swiper-slide">
            <product-item 
              data-customer-id=""
              data-product-id="${item.productId || ''}"
              data-product-title="${(item.title || '').replace(/"/g, '&quot;')}"
              data-sku="${item.skuCode || ''}"
              data-var-id="${item.variantId || ''}"
              data-price="${item.price || ''}"
              data-datalayer-item="true"
              class="bg-white flex flex-col justify-between bg-white hover-scale group"
            >
              <div class="relative overflow-hidden h-10r fb-md:h-14r w-full">
                <a href="/products/${smallsku}" 
                  data-sku="${item.skuCode || ''}" 
                  datalayer-link
                  class="relative h-full  flex items-center justify-center"
                >
                  ${item.newTag ? `<div class="z-2 absolute left-0 top-0 fb-flex-center">
                    <span class="absolute font-bold text-sm leading-[150%] text-white left-1.5 top-3 -rotate-45">NEW</span>
                    <svg class="w-auto h-auto" width="70" height="70" viewBox="0 0 70 70" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="-26" y="48.9998" width="104.538" height="30" transform="rotate(-45 -26 48.9998)" fill="#ED0006"/>
                    </svg>
                  </div>` : ''}
                  <img 
                    class="h-full w-auto fb-md:w-auto object-contain lazyload" 
                    loading="lazy"
                    data-media-id="${item.mediaId || ''}"
                    data-src="${item.mainPic || ''}"
                    width="300"
                    height="300"
                    alt="${(item.title || '').replace(/"/g, '&quot;')}"
                  >
                </a>
              </div>
              <div class="w-full mt-2.5 px-2 flex grow flex-col justify-between fb-md:px-5 pb-3 fb-md:pb-5">
                <a 
                  href="/products/${smallsku}"
                  datalayer-link=""
                  data-sku="${item.skuCode || ''}"
                  title="${(item.title || '').replace(/"/g, '&quot;')}"
                  class="w-full text-16  text-121212 mb-3 line-clamp-3  fb-md:min-h-18 fb-md:text-16 group-hover:underline fb-max-sm:text-14  min-h-18 fb-max-sm:min-h-16"
                >
                  ${item.title || ''}
                </a>
                <div class="w-full text-left text-22 font-bold fb-md:text-28 fb-max-sm:text-24">
                  ${skyprice}
                </div>
              </div>
            </product-item>
          </div>
        `;
      }
      initSwiper() {
        const swiperElement = this.sectionElement.querySelector('.swiper');
        if (!swiperElement) {
          return false;
        }
        return new Swiper(swiperElement, {
          slidesPerView: 'auto',
          spaceBetween: 20,
          scrollbar: {
            el: this.sectionElement.querySelector('.swiper-scrollbar'),
            draggable: true,
          },
          navigation: {
            nextEl: this.sectionElement.querySelector('.northsky-button-next'),
            prevEl: this.sectionElement.querySelector('.northsky-button-prev'),
          },
          breakpoints: {
            0: {
              spaceBetween: 12,
              slidesPerView: 2,
              slidesPerGroup: 2,
            },
            768: {
              spaceBetween: 24,
              slidesPerView: 3,
              slidesPerGroup: 3
            },
            1024: {
              spaceBetween: 24,
              slidesPerView: 4,
              slidesPerGroup: 4
            },
            1280: {
              spaceBetween: 24,
              slidesPerView: 5,
              slidesPerGroup: 5
            },
          }
        });
      }
      async fetchRecommendations() {
        try {   
          let url = `/openapi/recommend`;
          let params = {
            userId: window.northsky.customerId || '',
            anonymousId: window.gaGlobal?.vid || localStorage.getItem('ga4UserId') || '',
            count: 15,
          }
          {% if gtm_type == 'cart' %}
            url = `/openapi/recommend/cart`;
            const skus = [];
            {% for line_item in cart.items %}
              skus.push({
                nums: +'{{ line_item.quantity }}',
                skuAmount: +('{{ line_item.original_price | money_without_currency  }}'.replace(/,/g, '')),
                skuCode: '{{ line_item.sku }}'
              });
            {% endfor %}
            if(skus.length == 0){
              this.sectionElement.classList.add('hidden');
              return false
            }
            params.skuCodes = skus.map(item => item.skuCode);
          {% endif %}
          const result = await kkAjax.post(url, params);
          if (result.code !== 200 || !result.data || !Array.isArray(result.data) || result.data.length == 0) {
            this.sectionElement.classList.add('hidden');
            return false
          }
          this.sectionElement.querySelector('.js-swiper-btns').classList.add('fb-md:flex');

          const fragment = document.createDocumentFragment();
          const tempDiv = document.createElement('div');

          const swiperElement = this.sectionElement.querySelector('.swiper');
          const swiperWrapper = this.sectionElement.querySelector('.js-guess-content');
          if (!swiperElement) {
            return false;
          }
          swiperWrapper.innerHTML = '';
          result.data.forEach(item => {
            tempDiv.innerHTML = this.createProductHtml(item);
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild);
            }
          });
          swiperWrapper.appendChild(fragment);
          this.initSwiper();
        } catch (error) {
          console.log(error);
          this.sectionElement.classList.add('hidden');
        }
      }
      async init() {
        await this.fetchRecommendations()
        try {
          DataLayerManagerFactory.getInstance('{{ section.id }}').init();
        } catch (error) {
          console.log(error);
        }
      }
    }
    const guessYouLike = new GuessYouLike('{{ section.id }}');
    guessYouLike.init();
  })
</script>
{% schema %}
{
  "name": "Guess you like",
  "presets": [
    {
      "name": "guess-you-like"
    }
  ],
  "class": "product-swiper-list",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "You Might Like"
    }
  ]
}
{% endschema %}